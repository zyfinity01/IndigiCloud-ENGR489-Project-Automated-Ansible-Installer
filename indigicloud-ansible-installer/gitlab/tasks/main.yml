---
- name: Create directories for GitLab
  file:
    path: "/srv/gitlab/{{ item }}"
    state: directory
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0755"
  with_items:
    - config
    - data
    - logs

- name: Create Docker Compose file for GitLab
  copy:
    dest: /srv/gitlab/docker-compose.yml
    content: |
      services:
        gitlab:
          image: 'gitlab/gitlab-ce:latest'
          container_name: 'gitlab'
          restart: always
          hostname: '{{ gitlab_hostname }}'
          environment:
            GITLAB_OMNIBUS_CONFIG: |
              external_url '{{ gitlab_external_url }}'
          ports:
            - '8082:80'
            - '2222:22'
          volumes:
            - '/srv/gitlab/config:/etc/gitlab'
            - '/srv/gitlab/logs:/var/log/gitlab'
            - '/srv/gitlab/data:/var/opt/gitlab'

- name: Start GitLab using Docker Compose
  shell: |
    docker compose up -d
  args:
    chdir: /srv/gitlab
